<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Id√©es de sorties ‚ú®</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü•∞</text></svg>">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <style>
      /* --- TH√àME "PLUIE DE JUIN" --- */
      :root { 
        --misty-violet: #5f5baf; 
        --rainy-blue: #568de4; 
        --rain-purple: #ba9fe1; 
        --deep-iris: #9a64c5; 
        --cloudy-lilac: #c4c5e8; 
        --white: #ffffff; 
        --soft-bg: #fcfaff;
        --success-green: #48bb78;
        --success-bg: #f0fff4;
      }
      
      body { 
        font-family: 'Segoe UI', sans-serif; 
        background-color: var(--cloudy-lilac); 
        color: var(--misty-violet); 
        text-align: center; 
        margin: 0; 
        padding: 20px; 
        background-image: linear-gradient(to bottom, #c4c5e8 0%, #dce0f5 100%); 
        min-height: 100vh; 
      }
      
      h1 { 
        color: var(--misty-violet); 
        margin-top: 80px; 
        font-size: 2.2em; 
        text-shadow: 2px 2px 0px rgba(255,255,255,0.4); 
        margin-bottom: 5px;
      }
      
      .phrase { font-style: italic; color: var(--deep-iris); margin-bottom: 30px; font-weight: 500; }
      
      /* --- NAVIGATION --- */
      .top-nav { position: fixed; top: 10px; right: 10px; left: 10px; display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; z-index: 1000; }
      @media (min-width: 600px) { .top-nav { left: auto; justify-content: flex-end; } }

      .btn-nav, .btn-logout { border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 10px rgba(95, 91, 175, 0.1); transition: 0.3s; text-decoration: none; font-size: 0.85em; display: flex; align-items: center; justify-content: center; gap: 5px; backdrop-filter: blur(5px); }
      .btn-nav { background: rgba(255,255,255,0.8); color: var(--misty-violet); }
      .btn-nav:hover { background: var(--white); transform: translateY(-2px); }
      .btn-logout { background: #ffcdd2; color: #c62828; opacity: 0.9; }
      .btn-logout:hover { background: #ef9a9a; }

      /* --- ZONE DE SAISIE --- */
      .input-zone { background: var(--white); padding: 25px; border-radius: 25px; max-width: 500px; margin: 0 auto 40px auto; box-shadow: 0 10px 30px rgba(95, 91, 175, 0.2); border: 2px solid rgba(255,255,255,0.5); }

      input[type="text"], input[type="number"], input[type="date"] { padding: 12px 15px; border-radius: 12px; margin-top: 10px; border: 2px solid var(--cloudy-lilac); width: 100%; box-sizing: border-box; font-family: inherit; color: var(--misty-violet); background: var(--soft-bg); transition: 0.2s; }
      input:focus { outline: none; border-color: var(--rainy-blue); background: #fff; }

      /* Checkbox Formulaire Creation */
      .prevu-toggle {
          display: flex; align-items: center; justify-content: center; gap: 10px;
          margin: 15px 0 5px 0; background: #e6fffa; padding: 10px; border-radius: 12px;
          border: 1px dashed var(--success-green);
      }
      .prevu-toggle input { width: auto; margin: 0; transform: scale(1.3); accent-color: var(--success-green); cursor: pointer; }
      .prevu-toggle label { font-weight: bold; color: #2c7a7b; cursor: pointer; user-select: none; }

      #categories { margin-top: 15px; display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; }
      #categories input[type="checkbox"] { display: none; }
      #categories label { font-size: 0.85em; cursor: pointer; background: var(--soft-bg); padding: 8px 12px; border-radius: 20px; color: var(--misty-violet); transition: 0.2s; border: 1px solid var(--cloudy-lilac); user-select: none; }
      #categories input[type="checkbox"]:checked + label { background: var(--misty-violet); color: white; border-color: var(--misty-violet); transform: scale(1.05); box-shadow: 0 2px 5px rgba(95, 91, 175, 0.3); }

      .row-inputs { display: flex; gap: 10px; margin-top: 5px; }
      .row-inputs > * { flex: 1; }

      button.add { background: var(--rainy-blue); color: var(--white); cursor: pointer; border: none; padding: 12px 30px; border-radius: 15px; margin-top: 20px; font-size: 16px; font-weight: bold; width: 100%; transition: transform 0.2s; box-shadow: 0 5px 15px rgba(86, 141, 228, 0.3); }
      button.add:hover { background: var(--misty-violet); transform: translateY(-2px); }

      /* --- LISTE DES CARTES --- */
      #sorties { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; padding-bottom: 50px; max-width: 1200px; margin: 0 auto; }
      
      .carte { background: var(--white); width: 280px; padding: 20px; border-radius: 20px; box-shadow: 0 8px 20px rgba(95, 91, 175, 0.1); text-align: left; transition: transform 0.2s; position: relative; border-top: 6px solid var(--rainy-blue); display: flex; flex-direction: column; justify-content: space-between; }
      .carte:hover { transform: translateY(-5px); }
      
      /* Style carte pr√©vue */
      .carte.planned { border-top: 6px solid var(--success-green); background: var(--success-bg); }
      .carte.planned h3 { color: #2f855a; }

      .carte h3 { margin: 0 0 5px 0; color: var(--misty-violet); font-size: 1.2em; }
      .carte p { color: #666; font-size: 0.9em; margin: 5px 0; display: flex; align-items: center; gap: 5px; }
      
      .tags-container { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px; }
      .badge-cat { font-size: 0.75em; background: var(--misty-violet); padding: 3px 8px; border-radius: 10px; color: var(--white); font-weight: bold; }
      .carte.planned .badge-cat { background: #2f855a; }
      
      /* Zone de contr√¥le "Pr√©vu" sur la carte */
      .plan-control {
          background: rgba(255,255,255,0.7);
          padding: 8px;
          border-radius: 10px;
          margin-top: 10px;
          display: flex;
          align-items: center;
          justify-content: center;
          border: 1px dashed var(--cloudy-lilac);
      }
      .plan-label { display: flex; align-items: center; gap: 8px; font-weight: bold; font-size: 0.9em; color: var(--misty-violet); cursor: pointer; user-select: none; }
      .plan-label input { width: auto; margin: 0; transform: scale(1.2); accent-color: var(--success-green); }

      .infos-footer { margin-top: 10px; padding-top: 10px; border-top: 1px dashed var(--cloudy-lilac); display: flex; justify-content: space-between; align-items: center;}
      .date-display { color: var(--rainy-blue); font-weight: bold; font-size: 0.9em; }

      .btn-delete { background: none; border: none; cursor: pointer; font-size: 1.1em; color: #e57373; transition: 0.2s; padding: 5px; border-radius: 50%; }
      .btn-delete:hover { background: #ffebee; color: #c62828; }
    </style>
</head>
<body>

    <div class="top-nav">
        <a href="musees.html" class="btn-nav">üèõÔ∏è Mus√©es</a>
        <a href="sorties.html" class="btn-nav">üé≠ Spectacles</a>
        <a href="watchlist.html" class="btn-nav">üçø Watchlist</a>
        <button class="btn-logout" onclick="localStorage.removeItem('estConnecte'); window.location.href='login.html';">üîí D√©co</button>
    </div>

    <h1>ü•∞ Id√©es de sorties</h1>
    <div class="phrase">Pour nos moments √† nous...</div>

    <div class="input-zone">
      <input type="text" id="nouvelleIdee" placeholder="‚ú® Titre (ex: Resto Italien...)" />
      
      <div id="categories">
        <input type="checkbox" id="cat1" value="Resto"><label for="cat1">üçú Resto</label>
        <input type="checkbox" id="cat2" value="Cin√©"><label for="cat2">üçø Cin√©</label>
        <input type="checkbox" id="cat3" value="Balade"><label for="cat3">üå≥ Balade</label>
        <input type="checkbox" id="cat4" value="Maison"><label for="cat4">üè† Maison</label>
        <input type="checkbox" id="cat5" value="Activit√©"><label for="cat5">üé® Activit√©</label>
        <input type="checkbox" id="cat6" value="Surprise"><label for="cat6">üéÅ Surprise</label>
      </div>

      <div class="prevu-toggle">
          <input type="checkbox" id="estPrevu">
          <label for="estPrevu">C'est d√©j√† cal√© ! ‚úÖ</label>
      </div>

      <div class="row-inputs">
          <input type="date" id="dateIdee" title="Date pr√©vue" />
          <input type="number" id="prixIdee" placeholder="Prix (‚Ç¨)" />
      </div>
      
      <input type="text" id="lieuIdee" placeholder="üìç Lieu (ex: Paris, Canap√©...)" />
      
      <button class="add" onclick="ajouterIdee()">Ajouter √† la liste</button>
    </div>

    <div id="sorties">
        <p style="color: var(--misty-violet); font-style: italic;">Chargement des id√©es...</p>
    </div>

    <script>
        // üõë S√âCURIT√â
        if (!localStorage.getItem("estConnecte")) {
            window.location.href = "login.html";
        }

        // CONFIG FIREBASE
        const firebaseConfig = { 
            apiKey: "AIzaSyD9bzSuQY8CR9RVnQMu6WI4plznzQrfBC4", 
            authDomain: "date-d927b.firebaseapp.com", 
            projectId: "date-d927b", 
            storageBucket: "date-d927b.appspot.com", 
            messagingSenderId: "353304192798", 
            appId: "1:353304192798:web:1511fa87bfbf11bdda0b0f", 
            measurementId: "G-T4N8PMNC3G" 
        };
        
        if (typeof firebase !== 'undefined' && !firebase.apps.length) { 
            firebase.initializeApp(firebaseConfig); 
        }
        let db; 
        try { db = firebase.firestore(); } catch (e) { console.error("Erreur Firebase:", e); }

        // --- FONCTIONS ---

        function chargerIdees() { 
            const container = document.getElementById('sorties'); 
            
            db.collection("dates").onSnapshot((snapshot) => { 
                container.innerHTML = ""; 
                if(snapshot.empty) { container.innerHTML = "<p style='color:var(--misty-violet);'>Rien pour le moment...</p>"; return; } 
                
                let items = [];
                snapshot.forEach(doc => { items.push({ id: doc.id, ...doc.data() }); });

                // Tri : Pr√©vus en premier
                items.sort((a, b) => {
                    if (a.estPrevu && !b.estPrevu) return -1;
                    if (!a.estPrevu && b.estPrevu) return 1;
                    let timeA = (a.timestamp && a.timestamp.seconds) ? a.timestamp.seconds : 0;
                    let timeB = (b.timestamp && b.timestamp.seconds) ? b.timestamp.seconds : 0;
                    return timeB - timeA;
                });

                items.forEach((data) => { 
                    try {
                        const id = data.id;
                        const nom = data.texte || data.nom || "Id√©e sans titre"; 
                        const lieu = data.lieu ? `üìç ${data.lieu}` : "";
                        const prix = data.prix ? `üí∏ ${data.prix}‚Ç¨` : "";
                        const classCarte = data.estPrevu ? "carte planned" : "carte";
                        
                        let tagsHtml = "";
                        if (data.categories && Array.isArray(data.categories)) {
                            tagsHtml = data.categories.map(c => `<span class="badge-cat">${c}</span>`).join("");
                        } else if (typeof data.categories === 'string') {
                             tagsHtml = `<span class="badge-cat">${data.categories}</span>`;
                        }

                        let dateHtml = "";
                        // Si c'est pr√©vu, on affiche un texte sp√©cial
                        if (data.estPrevu && data.date) {
                            dateHtml = `<span style="color:#2f855a; font-weight:800; font-size:1.1em;">‚úÖ Pr√©vu le ${data.date}</span>`;
                        } else if (data.date) {
                            const today = new Date().toISOString().split('T')[0];
                            const color = data.date < today ? '#e57373' : 'var(--rainy-blue)';
                            const icon = data.date < today ? '‚ö†Ô∏è' : 'üìÖ';
                            dateHtml = `<span style="color:${color}">${icon} ${data.date}</span>`;
                        }

                        // √âtat de la case √† cocher
                        const checkedAttr = data.estPrevu ? "checked" : "";
                        const dateValue = data.date || ""; 

                        const carte = document.createElement("div"); 
                        carte.className = classCarte; 
                        carte.innerHTML = `
                            <div>
                                <div class="tags-container">${tagsHtml}</div>
                                <h3>${nom}</h3>
                                <p>${lieu}</p>
                                <p>${prix}</p>
                                
                                <div class="plan-control">
                                    <label class="plan-label">
                                        <input type="checkbox" ${checkedAttr} onchange="togglePrevu('${id}', this, '${dateValue}')">
                                        ${data.estPrevu ? "C'est cal√© !" : "On planifie ?"}
                                    </label>
                                </div>
                            </div>
                            
                            <div class="infos-footer">
                                <div class="date-display">${dateHtml}</div>
                                <button class="btn-delete" onclick="supprimerIdee('${id}')" title="Supprimer">üóëÔ∏è</button>
                            </div>
                        `; 
                        container.appendChild(carte); 
                    } catch (err) { console.log("Erreur affichage", err); }
                }); 
            }); 
        }

        // FONCTION POUR BASCULER L'√âTAT PR√âVU DEPUIS LA CARTE
        function togglePrevu(id, checkbox, currentDate) {
            if (checkbox.checked) {
                // On passe en mode "Pr√©vu" -> On demande la date
                let defaultDate = currentDate || new Date().toISOString().split('T')[0];
                let newDate = prompt("G√©nial ! C'est pour quand ? (AAAA-MM-JJ)", defaultDate);
                
                if (newDate) {
                    db.collection("dates").doc(id).update({ estPrevu: true, date: newDate });
                } else {
                    // Annulation
                    checkbox.checked = false;
                }
            } else {
                // On d√©coche -> On repasse en id√©e simple
                if(confirm("Ce n'est plus pr√©vu officiellement ? (La date restera indicative)")) {
                     db.collection("dates").doc(id).update({ estPrevu: false });
                } else {
                    checkbox.checked = true;
                }
            }
        }

        function ajouterIdee() { 
            const texte = document.getElementById("nouvelleIdee").value; 
            const date = document.getElementById("dateIdee").value; 
            const prix = document.getElementById("prixIdee").value; 
            const lieu = document.getElementById("lieuIdee").value; 
            const estPrevu = document.getElementById("estPrevu").checked;
            
            const checkboxes = document.querySelectorAll('#categories input:checked'); 
            let categories = []; 
            checkboxes.forEach((checkbox) => { categories.push(checkbox.value); }); 
            
            if (texte === "") { alert("Il faut au moins un titre !"); return; } 
            if (estPrevu && !date) { alert("Si c'est pr√©vu, il faut mettre une date !"); return; }

            db.collection("dates").add({ 
                texte: texte, nom: texte, categories: categories, date: date, prix: prix, lieu: lieu, 
                estPrevu: estPrevu, // On stocke le statut
                timestamp: firebase.firestore.FieldValue.serverTimestamp() 
            }).then(() => { 
                document.getElementById("nouvelleIdee").value = ""; 
                document.getElementById("dateIdee").value = ""; 
                document.getElementById("prixIdee").value = ""; 
                document.getElementById("lieuIdee").value = ""; 
                document.getElementById("estPrevu").checked = false;
                checkboxes.forEach(cb => cb.checked = false); 
            }).catch((error) => { alert("Erreur: " + error.message); }); 
        }

        function supprimerIdee(id) { 
            if(confirm("Veux-tu vraiment supprimer cette id√©e ?")) { db.collection("dates").doc(id).delete(); } 
        }

        document.addEventListener('DOMContentLoaded', () => { chargerIdees(); });
    </script>
</body>
</html>
