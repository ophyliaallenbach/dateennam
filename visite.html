<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Planning Admin ğŸ› ï¸</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ› ï¸</text></svg>">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <style>
        /* THÃˆME "SWEET MEMORIES" */
        :root { 
            --primary: #d53f8c; --secondary: #805ad5; --bg-soft: #fff5f7; 
            --white: #ffffff; --text-main: #2d3748;
            --type-visite: #e9d8fd; --type-manger: #fefcbf; --type-trajet: #edf2f7;
        }
        
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg-soft); color: var(--text-main); margin: 0; padding: 20px; background-image: linear-gradient(to bottom right, #fff5f7 0%, #ebf4ff 100%); min-height: 100vh; }
        
        .top-nav { position: fixed; top: 10px; right: 10px; display: flex; gap: 10px; z-index: 100; justify-content: center; }
        .btn-nav { background: rgba(255,255,255,0.8); padding: 8px 15px; border-radius: 20px; text-decoration: none; font-weight: bold; color: var(--secondary); transition: 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .btn-nav:hover { background: white; transform: translateY(-2px); }

        h1 { margin-top: 50px; text-align: center; color: var(--primary); font-size: 2em; margin-bottom: 5px; }
        .subtitle { text-align: center; font-style: italic; color: var(--secondary); margin-bottom: 30px; }
        
        #calendarContainer { max-width: 800px; margin: 0 auto; padding-bottom: 80px; }

        /* JOUR */
        .day-header { background: var(--primary); color: white; padding: 10px 20px; border-radius: 15px; margin: 30px 0 15px 0; font-size: 1.2em; font-weight: bold; text-align: center; position: sticky; top: 60px; z-index: 50; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

        /* TIMELINE ITEM */
        .timeline-item { display: flex; gap: 15px; margin-bottom: 15px; position: relative; }
        .time-col { min-width: 60px; text-align: right; font-weight: bold; color: var(--secondary); font-size: 0.9em; padding-top: 15px; }
        
        .content-col { 
            flex: 1; background: white; border-radius: 15px; padding: 15px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.03); border-left: 5px solid #ddd; 
            position: relative; transition: 0.2s;
        }
        
        /* TYPES COULEURS */
        .type-visite { border-left-color: var(--secondary); background: white; }
        .type-manger { border-left-color: #ecc94b; background: #fffff0; }
        .type-trajet { border-left-color: #cbd5e0; background: #f7fafc; color: #718096; }
        .locked-style { opacity: 0.7; background-color: #f0f0f0; border-left-color: #a0aec0; }

        .item-title { margin: 0 0 5px 0; font-size: 1.1em; color: var(--text-main); }
        .item-info { font-size: 0.9em; color: #718096; margin-bottom: 10px; display: flex; flex-wrap:wrap; gap: 10px; align-items: center; }
        .badge-prix { background: #fed7e2; color: #9b2c2c; padding: 2px 6px; border-radius: 5px; font-weight: bold; font-size: 0.85em;}
        .badge-info { background: rgba(0,0,0,0.05); padding: 2px 6px; border-radius: 5px; font-style: italic; }

        /* ADMIN CONTROLS */
        .admin-controls { position: absolute; top: 10px; right: 10px; display: flex; gap: 5px; }
        .btn-icon { background: none; border: none; cursor: pointer; font-size: 1.1em; opacity: 0.5; transition: 0.2s; }
        .btn-icon:hover { opacity: 1; transform: scale(1.1); }

        /* PARTICIPANTS */
        .participants-zone { margin-top: 10px; padding-top: 10px; border-top: 1px dashed #e2e8f0; display: flex; flex-wrap: wrap; gap: 5px; align-items: center; }
        .avatar { background: var(--secondary); color: white; padding: 3px 10px; border-radius: 12px; font-size: 0.8em; font-weight: bold; cursor: pointer; }
        .avatar:hover { opacity: 0.8; text-decoration: line-through; }
        .btn-join { background: none; border: 1px solid var(--secondary); color: var(--secondary); padding: 3px 10px; border-radius: 12px; font-size: 0.8em; cursor: pointer; font-weight: bold; }

        /* BOUTON FLOTTANT AJOUTER */
        .fab-add {
            position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px;
            background: var(--primary); color: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 30px; box-shadow: 0 4px 15px rgba(213, 63, 140, 0.4); 
            cursor: pointer; border: none; z-index: 90; transition: transform 0.2s;
        }
        .fab-add:hover { transform: scale(1.1) rotate(90deg); }

        /* POPUP MODAL (Add/Edit) */
        .modal-overlay { 
            position: fixed; top:0; left:0; width:100%; height:100%; 
            background:rgba(0,0,0,0.5); z-index:200; display:none; 
            justify-content:center; align-items:center; 
        }
        .modal-box { background:white; padding:25px; border-radius:20px; width:90%; max-width:400px; box-shadow:0 10px 25px rgba(0,0,0,0.2); }
        .modal-box h3 { margin-top: 0; color: var(--primary); }
        
        .form-row { display: flex; gap: 10px; }
        .form-row > * { flex: 1; }
        
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 2px solid #e2e8f0; border-radius: 10px; box-sizing: border-box; font-family: inherit; }
        
        .btn-save { width: 100%; background: var(--primary); color: white; padding: 12px; border-radius: 12px; border:none; font-weight:bold; cursor:pointer; margin-top:15px; font-size: 1em; }
        .btn-cancel { width:100%; background:none; border:none; color:#718096; margin-top:10px; cursor:pointer; }

    </style>
</head>
<body>

    <div class="top-nav">
        <a href="index.html" class="btn-nav">ğŸ  Accueil</a>
        <a href="watchlist.html" class="btn-nav">ğŸ¿ Watchlist</a>
        <button onclick="localStorage.removeItem('estConnecte'); window.location.href='login.html';" class="btn-nav" style="border:none; cursor:pointer;">ğŸ”’</button>
    </div>

    <h1>ğŸ› ï¸ Admin Programme</h1>
    <div class="subtitle">Organise tout dans les moindres dÃ©tails !</div>

    <div id="calendarContainer">Chargement...</div>

    <button class="fab-add" onclick="ouvrirModal('add')">ï¼‹</button>

    <div id="modalOverlay" class="modal-overlay">
        <div class="modal-box">
            <h3 id="modalTitle">Ajouter une activitÃ©</h3>
            <input type="hidden" id="itemId">
            
            <label style="font-size:0.8em; font-weight:bold; color:var(--secondary);">Quoi ?</label>
            <input type="text" id="titre" placeholder="Titre (ex: Resto Italien)">
            
            <div class="form-row">
                <div>
                    <label style="font-size:0.8em; font-weight:bold; color:var(--secondary);">Type</label>
                    <select id="type">
                        <option value="visite">ğŸ›ï¸ Visite</option>
                        <option value="manger">ğŸ´ Repas</option>
                        <option value="trajet">ğŸš‡ Trajet</option>
                    </select>
                </div>
                <div>
                    <label style="font-size:0.8em; font-weight:bold; color:var(--secondary);">Prix</label>
                    <input type="text" id="prix" placeholder="ex: 15â‚¬">
                </div>
            </div>

            <label style="font-size:0.8em; font-weight:bold; color:var(--secondary);">Quand ?</label>
            <div class="form-row">
                <input type="date" id="date">
                <input type="time" id="heure">
            </div>

            <label style="font-size:0.8em; font-weight:bold; color:var(--secondary);">DÃ©tails (Trajet, Infos...)</label>
            <input type="text" id="info" placeholder="ex: Prendre la ligne 6, RDV devant...">

            <button class="btn-save" onclick="sauvegarder()">Enregistrer</button>
            <button class="btn-cancel" onclick="fermerModal()">Annuler</button>
        </div>
    </div>

    <script>
        if (!localStorage.getItem("estConnecte")) { window.location.href = "login.html"; }

        const firebaseConfig = { 
            apiKey: "AIzaSyD9bzSuQY8CR9RVnQMu6WI4plznzQrfBC4", 
            authDomain: "date-d927b.firebaseapp.com", 
            projectId: "date-d927b", 
            storageBucket: "date-d927b.appspot.com", 
            messagingSenderId: "353304192798", 
            appId: "1:353304192798:web:1511fa87bfbf11bdda0b0f", 
            measurementId: "G-T4N8PMNC3G" 
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // MODE ACTUEL (add ou edit)
        let mode = 'add'; 

        // --- AFFICHAGE ROBUSTE ---
        function chargerPlanning() {
            db.collection("planning_visite").orderBy("sortKey", "asc").onSnapshot(snapshot => {
                const container = document.getElementById("calendarContainer");
                container.innerHTML = "";
                let currentDay = "";

                if(snapshot.empty) { container.innerHTML = "<p>Aucune activitÃ©. Clique sur le gros â• !</p>"; return; }

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const id = doc.id;

                    // Gestion Jour (Affichage Header)
                    // Utilisation de createElement pour Ã©viter les bugs de innerHTML
                    if (data.jour !== currentDay) {
                        currentDay = data.jour;
                        const header = document.createElement("div");
                        header.className = "day-header";
                        header.textContent = currentDay;
                        container.appendChild(header);
                    }

                    // Styles
                    let typeClass = "type-visite";
                    if (data.type === "manger") typeClass = "type-manger";
                    if (data.type === "trajet") typeClass = "type-trajet";
                    
                    let lockClass = data.verrouille ? "locked-style" : "";
                    let lockIcon = data.verrouille ? "ğŸ”’" : "ğŸ”“";

                    let prixBadge = data.prix ? `<span class="badge-prix">${data.prix}</span>` : "";
                    let infoBadge = data.info ? `<span class="badge-info">${data.info}</span>` : "";

                    // Participants
                    let partsHtml = "";
                    if (data.participants) {
                        partsHtml = data.participants.map(p => `<span class="avatar" onclick="retirer('${id}', '${p}')">${p}</span>`).join("");
                    }

                    const item = document.createElement("div");
                    item.className = "timeline-item";
                    item.innerHTML = `
                        <div class="time-col">${data.heure}</div>
                        <div class="content-col ${typeClass} ${lockClass}">
                            <div class="admin-controls">
                                <button class="btn-icon" onclick="ouvrirModal('edit', '${id}')">âœï¸</button>
                                <button class="btn-icon" onclick="toggleVerrou('${id}', ${data.verrouille})">${lockIcon}</button>
                                <button class="btn-icon" onclick="supprimer('${id}')" style="color:#feb2b2;">ğŸ—‘ï¸</button>
                            </div>

                            <h3 class="item-title">${data.activite} ${data.verrouille ? '<small>(FermÃ©)</small>' : ''}</h3>
                            <div class="item-info">
                                ${prixBadge} ${infoBadge}
                            </div>
                            
                            <div class="participants-zone">
                                ${partsHtml}
                                <button class="btn-join" onclick="rejoindre('${id}')">+ Moi</button>
                            </div>
                        </div>
                    `;
                    container.appendChild(item);
                });
            });
        }

        // --- GESTION MODAL (AJOUT / EDIT) ---
        function ouvrirModal(action, id = null) {
            mode = action;
            document.getElementById('modalOverlay').style.display = 'flex';
            
            if (mode === 'add') {
                document.getElementById('modalTitle').innerText = "Ajouter une activitÃ©";
                document.getElementById('itemId').value = "";
                document.getElementById('titre').value = "";
                document.getElementById('prix').value = "";
                document.getElementById('info').value = "";
                document.getElementById('heure').value = "";
                document.getElementById('date').value = new Date().toISOString().split('T')[0];
                document.getElementById('type').value = "visite";
            } else {
                document.getElementById('modalTitle').innerText = "Modifier l'activitÃ©";
                // RÃ©cupÃ©rer les infos
                db.collection("planning_visite").doc(id).get().then(doc => {
                    const d = doc.data();
                    document.getElementById('itemId').value = id;
                    document.getElementById('titre').value = d.activite;
                    document.getElementById('prix').value = d.prix || "";
                    document.getElementById('info').value = d.info || "";
                    document.getElementById('heure').value = d.heure || "";
                    document.getElementById('type').value = d.type || "visite";
                    
                    // RÃ©cupÃ©ration de la date (si dispo dans sortKey ou ailleurs)
                    // Si sortKey format "YYYYMMDD-HHMM", on essaie de l'extraire
                    if(d.sortKey && d.sortKey.length >= 8) {
                        const y = d.sortKey.substring(0,4);
                        const m = d.sortKey.substring(4,6);
                        const day = d.sortKey.substring(6,8);
                        // On vÃ©rifie si c'est des nombres pour Ã©viter les crashs sur anciens formats
                        if(!isNaN(y) && !isNaN(m) && !isNaN(day)) {
                            document.getElementById('date').value = `${y}-${m}-${day}`;
                        } else {
                            document.getElementById('date').value = new Date().toISOString().split('T')[0];
                        }
                    } else {
                        document.getElementById('date').value = new Date().toISOString().split('T')[0];
                    }
                });
            }
        }

        function fermerModal() { document.getElementById('modalOverlay').style.display = 'none'; }

        function sauvegarder() {
            const titre = document.getElementById('titre').value;
            const type = document.getElementById('type').value;
            const prix = document.getElementById('prix').value;
            const info = document.getElementById('info').value;
            const dateStr = document.getElementById('date').value; // YYYY-MM-DD
            const timeStr = document.getElementById('heure').value; // HH:MM

            if(!titre) return alert("Il faut un titre !");
            if(!dateStr) return alert("Il faut une date !"); // SÃ©curitÃ© anti-disparition

            try {
                // Calcul du Jour (Lundi, Mardi...)
                const dateObj = new Date(dateStr);
                const options = { weekday: 'long' };
                const jourNom = new Intl.DateTimeFormat('fr-FR', options).format(dateObj);
                const jourCapitalized = jourNom.charAt(0).toUpperCase() + jourNom.slice(1);

                // ClÃ© de tri (ex: 20240520-1430)
                const sortKey = dateStr.replace(/-/g, '') + '-' + timeStr.replace(':', '');

                const data = {
                    activite: titre,
                    type: type,
                    prix: prix,
                    info: info,
                    heure: timeStr,
                    jour: jourCapitalized,
                    sortKey: sortKey
                };

                if (mode === 'add') {
                    data.participants = [];
                    data.verrouille = false;
                    data.timestamp = firebase.firestore.FieldValue.serverTimestamp();
                    db.collection("planning_visite").add(data).then(() => fermerModal());
                } else {
                    const id = document.getElementById('itemId').value;
                    db.collection("planning_visite").doc(id).update(data).then(() => fermerModal());
                }
            } catch (err) {
                alert("Erreur lors de la sauvegarde : " + err.message);
            }
        }

        // --- AUTRES ACTIONS ---
        function toggleVerrou(id, etat) { db.collection("planning_visite").doc(id).update({ verrouille: !etat }); }
        function supprimer(id) { if(confirm("Supprimer ?")) db.collection("planning_visite").doc(id).delete(); }
        
        function rejoindre(id) {
            const prenom = prompt("Ajouter qui ?");
            if(prenom) db.collection("planning_visite").doc(id).update({ participants: firebase.firestore.FieldValue.arrayUnion(prenom) });
        }
        function retirer(id, prenom) {
            if(confirm("Retirer " + prenom + " ?")) db.collection("planning_visite").doc(id).update({ participants: firebase.firestore.FieldValue.arrayRemove(prenom) });
        }

        document.addEventListener('DOMContentLoaded', chargerPlanning);
    </script>
</body>
</html>
