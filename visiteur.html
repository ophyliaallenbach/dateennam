<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8">
    <title>Vitrine Culturelle ‚ú®</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚ú®</text></svg>">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <style>
      /* THEME MIXTE (Bleu/Violet) */
      :root { --main-color: #5c6bc0; --bg-color: #e8eaf6; --white: #ffffff; --alert-red: #e57373; --text: #283593; }
      body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg-color); color: var(--text); text-align: center; margin: 0; padding: 20px; min-height: 100vh; }
      
      h1 { color: var(--main-color); margin-top: 50px; font-size: 2.2em; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
      .phrase { font-style: italic; color: #7986cb; margin-bottom: 40px; font-weight: 500; }
      
      /* BOUTON RETOUR */
      .top-nav { position: fixed; top: 10px; left: 10px; z-index: 1000; }
      .btn-back { background: rgba(255,255,255,0.8); color: var(--main-color); border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-weight: bold; backdrop-filter: blur(5px); text-decoration: none; display: flex; align-items: center; gap: 5px; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
      .btn-back:hover { background: var(--white); transform: translateY(-2px); }

      /* GRILLE CARTES */
      #vitrine { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; padding-bottom: 50px; max-width: 1200px; margin: 0 auto; }
      
      .carte { background: var(--white); width: 280px; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(92, 107, 192, 0.15); text-align: left; transition: transform 0.2s; position: relative; animation: fadeIn 0.5s ease; border-left: 5px solid var(--main-color); }
      .carte:hover { transform: translateY(-5px); }
      
      .type-badge { position: absolute; top: 15px; right: 15px; font-size: 1.2em; }
      
      .carte h3 { margin: 0 0 5px 0; color: #1a237e; font-size: 1.2em; padding-right: 30px; }
      .carte h4 { margin: 0 0 10px 0; color: #5c6bc0; font-size: 1em; font-weight: normal; }
      .carte p { color: #555; font-size: 0.9em; margin: 5px 0; }
      
      .date-fin-alert { 
          display: block; 
          margin-top: 15px; 
          padding: 8px; 
          background: #ffebee; 
          color: #c62828; 
          border-radius: 8px; 
          font-weight: bold; 
          font-size: 0.9em; 
          text-align: center; 
          border: 1px dashed #ef9a9a; 
      }
      
      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
      .empty-msg { font-style: italic; color: #888; margin-top: 50px; font-size: 1.2em; }
    </style>
  </head>
  <body>
    
    <div class="top-nav">
        <a href="login.html" class="btn-back">‚¨Ö Retour</a>
    </div>

    <h1>‚ú® Vitrine Culturelle</h1>
    <div class="phrase">Les expos & spectacles du moment...</div>

    <div id="vitrine">Chargement...</div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyD9bzSuQY8CR9RVnQMu6WI4plznzQrfBC4", authDomain: "date-d927b.firebaseapp.com", projectId: "date-d927b", storageBucket: "date-d927b.appspot.com", messagingSenderId: "353304192798", appId: "1:353304192798:web:1511fa87bfbf11bdda0b0f", measurementId: "G-T4N8PMNC3G" };
        if (typeof firebase !== 'undefined' && !firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        let db; try { db = firebase.firestore(); } catch (e) { console.error("Erreur:", e); }

        function chargerVitrine() { 
            const container = document.getElementById('vitrine'); 
            
            Promise.all([
                db.collection('musees').get(),
                db.collection('sorties').get()
            ]).then(results => {
                const museesSnapshot = results[0];
                const sortiesSnapshot = results[1];
                let elements = [];

                // 1. RECUPERER LES MUSEES
                museesSnapshot.forEach(doc => {
                    const data = doc.data();
                    
                    // Formatage donn√©es
                    let listeExpos = [];
                    if (data.expositions && Array.isArray(data.expositions)) {
                        listeExpos = data.expositions;
                    } else {
                        listeExpos = [{ nom: data.expo || "Expo", dateFin: data.dateFinExpo || "" }];
                    }

                    listeExpos.forEach(expo => {
                        // On n'affiche que si c'est pertinent (pas forc√©ment visit√©, mais qui existe)
                        elements.push({
                            type: 'üèõÔ∏è',
                            titre: data.nom,
                            sousTitre: expo.nom,
                            lieu: "Mus√©e",
                            prix: data.prix,
                            dateFin: expo.dateFin || null, // DATE DE FIN DE L'EXPO
                            sortDate: expo.dateFin || "9999-99-99" // Pour trier
                        });
                    });
                });

                // 2. RECUPERER LES SPECTACLES
                sortiesSnapshot.forEach(doc => {
                    const data = doc.data();
                    // On affiche les spectacles
                    let dateFin = data.dateFin || null;
                    // Si c'est permanent, pas de date de fin stricte
                    
                    elements.push({
                        type: 'üé≠',
                        titre: data.titre || data.nom,
                        sousTitre: data.type === 'permanente' ? 'Offre Permanente' : '√âv√©nement',
                        lieu: data.lieu || "",
                        prix: data.prix,
                        dateFin: dateFin, // DATE DE FIN DU SPECTACLE
                        sortDate: dateFin || "9999-99-99"
                    });
                });

                // 3. TRIER PAR DATE DE FIN (Les plus urgents en premier)
                elements.sort((a, b) => a.sortDate.localeCompare(b.sortDate));

                // 4. AFFICHAGE
                container.innerHTML = "";
                if(elements.length === 0) {
                    container.innerHTML = "<p class='empty-msg'>Aucune info culturelle trouv√©e...</p>";
                    return;
                }

                elements.forEach(item => {
                    // Construction de l'alerte date
                    let dateHtml = "";
                    if (item.dateFin) {
                        dateHtml = `<span class="date-fin-alert">‚ö†Ô∏è Jusqu'au : ${item.dateFin}</span>`;
                    } else {
                        dateHtml = `<span style="display:block; margin-top:15px; color:#888; font-size:0.85em; text-align:center;">(Pas de date de fin)</span>`;
                    }

                    const carte = document.createElement("div"); 
                    carte.className = "carte"; 
                    carte.innerHTML = `
                        <div class="type-badge">${item.type}</div>
                        <h3>${item.titre}</h3>
                        <h4>${item.sousTitre}</h4>
                        <p>üìç ${item.lieu} ${item.prix ? `| üí∏ ${item.prix}‚Ç¨` : ""}</p>
                        ${dateHtml}
                    `; 
                    container.appendChild(carte); 
                });
            });
        }
        
        document.addEventListener('DOMContentLoaded', () => { chargerVitrine(); });
    </script>
  </body>
</html>
