<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Livre d'Or Invit√©</title>
     <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üñãÔ∏è</text></svg>">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #e0f7fa; color: #006064; padding: 20px; text-align: center; display:flex; flex-direction:column; min-height:90vh; justify-content:center;}
        .container { max-width: 500px; margin: 0 auto; background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width:90%; }
        h1 { color: #00838f; margin-bottom: 5px; }
        p { color: #666; font-size: 0.9em; margin-bottom: 25px; }
        select, input, textarea { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #b2ebf2; border-radius: 10px; box-sizing: border-box; font-family: inherit; }
        button { background: #00838f; color: white; border: none; padding: 15px; width: 100%; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 1.1em; margin-top: 10px; }
        button:hover { background: #006064; }
        .back-btn { background: none; color: #00838f; margin-top: 15px; font-size: 0.9em; text-decoration: underline; cursor: pointer; border: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üñãÔ∏è Ton avis compte !</h1>
        <p>Choisis une sortie qu'on a faite ensemble :</p>
        
        <div id="loading">Recherche des souvenirs...</div>
        
        <div id="formulaire" style="display:none;">
            <label style="font-weight:bold; display:block; text-align:left;">1. Quelle sortie ?</label>
            <select id="choixExpo">
                <option value="">-- Choisis dans la liste --</option>
            </select>

            <label style="font-weight:bold; display:block; text-align:left; margin-top:10px;">2. C'est qui ?</label>
            <input type="text" id="nomInvite" placeholder="Ton pr√©nom (ex: Maman, Ch√©ri...)">

            <label style="font-weight:bold; display:block; text-align:left; margin-top:10px;">3. Ton avis :</label>
            <textarea id="avisInvite" rows="4" placeholder="J'ai ador√© parce que..."></textarea>

            <button onclick="envoyerAvis()">üíå Envoyer l'avis</button>
        </div>
        
        <button class="back-btn" onclick="window.location.href='login.html'">Retour connexion</button>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyD9bzSuQY8CR9RVnQMu6WI4plznzQrfBC4", authDomain: "date-d927b.firebaseapp.com", projectId: "date-d927b", storageBucket: "date-d927b.appspot.com", messagingSenderId: "353304192798", appId: "1:353304192798:web:1511fa87bfbf11bdda0b0f", measurementId: "G-T4N8PMNC3G" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        Promise.all([
            db.collection('musees').get(),
            db.collection('sorties').get()
        ]).then(results => {
            const museesSnapshot = results[0];
            const sortiesSnapshot = results[1];
            const select = document.getElementById('choixExpo');
            let count = 0;

            // 1. LES MUSEES (Logique blind√©e gr√¢ce √† ta capture d'√©cran)
            museesSnapshot.forEach(doc => {
                const data = doc.data();
                
                // CAS A : Format "Liste d'expos" (Le nouveau standard)
                if(data.expositions && Array.isArray(data.expositions)) {
                    data.expositions.forEach((expo, index) => {
                        if(expo.estVisite) {
                            ajouterOption(select, {
                                type: 'musee',
                                id: doc.id,
                                expoIndex: index, // On garde l'index pour savoir laquelle c'est
                                titre: data.nom + " (" + expo.nom + ")"
                            }, `üèõÔ∏è ${data.nom} - ${expo.nom}`);
                            count++;
                        }
                    });
                } 
                // CAS B : Format "Plat" (Celui de ta capture d'√©cran - Monnaie de Paris)
                else if (data.estVisite === true) {
                    ajouterOption(select, {
                        type: 'musee',
                        id: doc.id,
                        expoIndex: 0, // Par d√©faut c'est la premi√®re
                        titre: data.nom + " (" + (data.expo || "Expo") + ")"
                    }, `üèõÔ∏è ${data.nom} - ${data.expo || "Visite"}`);
                    count++;
                }
            });

            // 2. LES SPECTACLES
            sortiesSnapshot.forEach(doc => {
                const data = doc.data();
                if(data.estFait) {
                    ajouterOption(select, {
                        type: 'sortie',
                        id: doc.id,
                        titre: data.titre || data.nom
                    }, `üé≠ ${data.titre || data.nom}`);
                    count++;
                }
            });

            document.getElementById('loading').style.display = 'none';
            if(count > 0) {
                document.getElementById('formulaire').style.display = 'block';
            } else {
                document.getElementById('loading').innerHTML = "Aucune visite termin√©e trouv√©e... üò¢";
                document.getElementById('loading').style.display = 'block';
            }
        });

        function ajouterOption(select, valueObj, text) {
            let option = document.createElement('option');
            option.value = JSON.stringify(valueObj);
            option.textContent = text;
            select.appendChild(option);
        }

        function envoyerAvis() {
            const selection = document.getElementById('choixExpo').value;
            const nom = document.getElementById('nomInvite').value;
            const avis = document.getElementById('avisInvite').value;

            if(!selection || !nom || !avis) { alert("Il faut tout remplir !"); return; }

            const dataSelect = JSON.parse(selection);

            // Envoi vers la bo√Æte de r√©ception Admin
            db.collection('propositions').add({
                typeCible: 'avis_invite', 
                sourceType: dataSelect.type, 
                docId: dataSelect.id,       
                expoIndex: dataSelect.expoIndex, 
                titreContext: dataSelect.titre, 
                auteur: nom,
                commentaire: avis,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                alert("Merci " + nom + " ! Ton mot doux a √©t√© envoy√©. ‚ú®");
                window.location.href = "login.html"; 
            });
        }
    </script>
</body>
</html>
