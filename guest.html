<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Livre d'Or Invit√© üñãÔ∏è</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #e0f7fa; color: #006064; padding: 20px; text-align: center; display:flex; flex-direction:column; min-height:90vh; justify-content:center;}
        .container { max-width: 500px; margin: 0 auto; background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width:90%; }
        h1 { color: #00838f; margin-bottom: 5px; }
        p { color: #666; font-size: 0.9em; margin-bottom: 25px; }
        select, input, textarea { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #b2ebf2; border-radius: 10px; box-sizing: border-box; font-family: inherit; }
        button { background: #00838f; color: white; border: none; padding: 15px; width: 100%; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 1.1em; margin-top: 10px; }
        button:hover { background: #006064; }
        .back-btn { background: none; color: #00838f; margin-top: 15px; font-size: 0.9em; text-decoration: underline; cursor: pointer; border: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üñãÔ∏è Ton avis compte !</h1>
        <p>Choisis une sortie qu'on a faite ensemble :</p>
        
        <div id="loading">Chargement des souvenirs...</div>
        
        <div id="formulaire" style="display:none;">
            <label style="font-weight:bold; display:block; text-align:left;">1. Quelle sortie ?</label>
            <select id="choixExpo">
                <option value="">-- Choisis dans la liste --</option>
            </select>

            <label style="font-weight:bold; display:block; text-align:left; margin-top:10px;">2. C'est qui ?</label>
            <input type="text" id="nomInvite" placeholder="Ton pr√©nom (ex: Maman, Ch√©ri...)">

            <label style="font-weight:bold; display:block; text-align:left; margin-top:10px;">3. Ton avis :</label>
            <textarea id="avisInvite" rows="4" placeholder="J'ai ador√© parce que..."></textarea>

            <button onclick="envoyerAvis()">üíå Envoyer l'avis</button>
        </div>
        
        <button class="back-btn" onclick="window.location.href='login.html'">Retour</button>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyD9bzSuQY8CR9RVnQMu6WI4plznzQrfBC4", authDomain: "date-d927b.firebaseapp.com", projectId: "date-d927b", storageBucket: "date-d927b.appspot.com", messagingSenderId: "353304192798", appId: "1:353304192798:web:1511fa87bfbf11bdda0b0f", measurementId: "G-T4N8PMNC3G" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // ON CHERCHE PARTOUT (Mus√©es ET Spectacles)
        Promise.all([
            db.collection('musees').get(),
            db.collection('sorties').get()
        ]).then(results => {
            const museesSnapshot = results[0];
            const sortiesSnapshot = results[1];
            const select = document.getElementById('choixExpo');
            let count = 0;

            // 1. LES MUSEES
            museesSnapshot.forEach(doc => {
                const data = doc.data();
                if(data.expositions) {
                    data.expositions.forEach((expo, index) => {
                        // On v√©rifie si c'est visit√© (true ou "true")
                        if(expo.estVisite) {
                            let option = document.createElement('option');
                            // On stocke l'info : C'est un MUSEE
                            option.value = JSON.stringify({ 
                                type: 'musee',
                                id: doc.id, 
                                expoIndex: index, 
                                titre: data.nom + " (" + expo.nom + ")" 
                            });
                            option.textContent = `üèõÔ∏è ${data.nom} - ${expo.nom}`;
                            select.appendChild(option);
                            count++;
                        }
                    });
                }
            });

            // 2. LES SPECTACLES (SORTIES)
            sortiesSnapshot.forEach(doc => {
                const data = doc.data();
                // Si la sortie est marqu√©e comme FAITE
                if(data.estFait) {
                    let option = document.createElement('option');
                    // On stocke l'info : C'est une SORTIE
                    option.value = JSON.stringify({ 
                        type: 'sortie',
                        id: doc.id, 
                        titre: data.titre || data.nom
                    });
                    option.textContent = `üé≠ ${data.titre || data.nom}`;
                    select.appendChild(option);
                    count++;
                }
            });

            document.getElementById('loading').style.display = 'none';
            if(count > 0) {
                document.getElementById('formulaire').style.display = 'block';
            } else {
                document.getElementById('loading').innerHTML = "Aucune visite termin√©e trouv√©e... <br>üò¢<br><small>(L'admin doit cocher 'C'est fait' sur une carte)</small>";
                document.getElementById('loading').style.display = 'block';
            }
        });

        function envoyerAvis() {
            const selection = document.getElementById('choixExpo').value;
            const nom = document.getElementById('nomInvite').value;
            const avis = document.getElementById('avisInvite').value;

            if(!selection || !nom || !avis) { alert("Remplis tout s'il te pla√Æt !"); return; }

            const dataSelect = JSON.parse(selection);

            // On envoie dans la boite de r√©ception
            db.collection('propositions').add({
                typeCible: 'avis_invite', 
                sourceType: dataSelect.type, // 'musee' ou 'sortie'
                docId: dataSelect.id,        // ID du document parent
                expoIndex: dataSelect.expoIndex, // Index si c'est un mus√©e (sinon undefined)
                titreContext: dataSelect.titre, 
                auteur: nom,
                commentaire: avis,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                alert("Merci " + nom + " ! Ton avis a √©t√© envoy√©. ‚ú®");
                window.location.href = "login.html"; // Retour accueil
            });
        }
    </script>
</body>
</html>
